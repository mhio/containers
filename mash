#!/usr/bin/env bash
set -ueo pipefail
dateTime(){ date -u '+%Y-%m-%dT%H:%M:%SZ'; }
rundir=$(cd -P -- "$(dirname -- "$0")" && printf '%s\n' "$(pwd -P)")
cd "$rundir"

# {make.sh user}

IMAGE_REPO="me"

run:build (){
  run:build:debian-base
  run:build:debian-interactive
  run:build:debian-nix
  run:build:debian-zsh
  run:build:debian-deno
}

run:build:debian-base(){
  docker pull debian:11
  cd "$rundir"/debian-base
  docker build -t "${IMAGE_REPO}/debian-base:11" -t "${IMAGE_REPO}/debian-base:latest" -t "${IMAGE_REPO}/debian:latest" -t "mdeb" .
}
run:build:debian-interactive(){
  cd "$rundir"/debian-interactive
  docker build -t "${IMAGE_REPO}/debian-interactive:11" -t "${IMAGE_REPO}/debian-interactive:latest" -t "mdebi" .
}
run:build:debian-nix () {
  cd "$rundir"/debian-nix
  docker build -t "${IMAGE_REPO}/debian-nix:11" -t "${IMAGE_REPO}/debian-nix:latest" -t "mdebn" .
}
run:build:debian-zsh () {
  cd "$rundir"/debian-zsh
  docker build -t "${IMAGE_REPO}/debian-zsh:11" -t "${IMAGE_REPO}/debian-zsh:latest" -t "mdebz" .
}
run:build:debian-deno () {
  cd "$rundir"/debian-deno
  docker build -t "${IMAGE_REPO}/debian-deno:11" -t "${IMAGE_REPO}/debian-deno:latest" -t "mdebd" .
}

run:run:debian-base(){
  local type_name="$1"
  shift
  docker run --interactive --tty --rm "${IMAGE_REPO}/debian-${type_name}:latest" "$@"
}

run:debian(){
  run:run:debian-base interactive "$@"
}

run:nix(){
  run:run:debian-base nix "$@"
}

run:zsh(){
  run:run:debian-base zsh "$@"
}

run:deno(){
  run:run:debian-base deno "$@"
}

run:docker () {
  docker run \
   --interactive --tty \
   --env DEBUG=true \
   --rm \
   --name "${CONTAINER_NAME}" \
   "${IMAGE_REPO}:${IMAGE_TAG}" \
   "$@"
}

# {make.sh common}
run:completion:words(){
  declare -F | awk '/^declare -f run:/ { if (/run:completion:/) { next; }; printf("%s\n", substr($0,16)); }'
}
run:help(){
  set +x
  echo "Commands:"
  run:completion:words | awk '{ printf("  %s\n", $0); }'
  exit 1
}
[ -z "${1:-}" ] && run:help
cmd=$1
shift
[[ "$cmd" == completion:* ]] || set -x
run:"$cmd" "$@"

